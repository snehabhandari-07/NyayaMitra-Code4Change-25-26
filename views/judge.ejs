<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Judge Dashboard | NyayaMitra</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
/* ==========================================
   NYAYAMITRA ‚Äì SUPREME / HIGH COURT BRANDING
   Official Judicial Theme (Inline CSS)
========================================== */

:root {
  --court-navy: #0b1f3a;       /* Supreme Court Navy */
  --court-maroon: #6b1f1f;    /* High Court Maroon */
  --court-gold: #c7a008;      /* Emblem Gold */
  --court-bg: #f4f6f8;
  --card-bg: #ffffff;
  --border-soft: #d1d5db;
  --text-muted: #6b7280;
}

body {
  background: var(--court-bg);
  font-family: "Inter", system-ui, sans-serif;
}

/* ===== SIDEBAR ===== */
.sidebar {
  background: linear-gradient(180deg, var(--court-navy), #050f1f);
  color: #ffffff;
  border-radius: 14px;
  padding: 24px;
  min-height: 92vh;
  box-shadow: 0 14px 36px rgba(0, 0, 0, 0.25);
}

.sidebar .brand {
  font-size: 1.15rem;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.sidebar .muted-sm {
  font-size: 0.75rem;
  opacity: 0.75;
}

.sidebar hr {
  border-color: rgba(255, 255, 255, 0.25);
}

.sidebar .nav-link {
  color: #e5e7eb;
  padding: 11px 16px;
  border-radius: 8px;
  margin-bottom: 6px;
  font-weight: 500;
  transition: all 0.25s ease;
}

.sidebar .nav-link:hover,
.sidebar .nav-link.active {
  background: rgba(255, 255, 255, 0.18);
  color: #fff;
}

/* ===== HEADER ===== */
.header-top {
  background: #ffffff;
  border-radius: 14px;
  padding: 20px 24px;
  border-left: 6px solid var(--court-gold);
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.1);
}

.header-top h4 {
  margin: 0;
  font-weight: 700;
  color: var(--court-navy);
}

.header-top .muted-sm {
  font-size: 0.8rem;
  color: var(--text-muted);
}

/* ===== CARDS ===== */
.card {
  background: var(--card-bg);
  border: none;
  border-radius: 14px;
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.08);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.14);
}

.card h6 {
  font-weight: 600;
  color: var(--court-navy);
}

/* ===== PRIORITY CARDS ===== */
.priority-card {
  border-radius: 16px;
  padding: 24px;
  color: #fff;
  box-shadow: 0 14px 34px rgba(0, 0, 0, 0.25);
  transition: transform 0.25s ease;
}

.priority-card:hover {
  transform: scale(1.04);
}

.priority-card.high {
  background: linear-gradient(135deg, #7f1d1d, #991b1b);
}

.priority-card.medium {
  background: linear-gradient(135deg, #b45309, #92400e);
}

.priority-card.low {
  background: linear-gradient(135deg, #166534, #14532d);
}

/* ===== TABS ===== */
.nav-tabs {
  border-bottom: 2px solid var(--border-soft);
}

.nav-tabs .nav-link {
  font-weight: 600;
  color: var(--court-navy);
  border: none;
  border-bottom: 3px solid transparent;
}

.nav-tabs .nav-link.active {
  border-bottom: 3px solid var(--court-gold);
  color: var(--court-maroon);
}

/* ===== TIMELINE ===== */
.timeline-list {
  list-style: none;
  padding-left: 0;
}

.timeline-list li {
  background: #ffffff;
  border-left: 4px solid var(--court-gold);
  padding: 14px 18px;
  border-radius: 8px;
  margin-bottom: 10px;
}

/* ===== BUTTONS ===== */
.btn-primary {
  background: linear-gradient(180deg, #1e3a8a 0%, #2563eb 100%);
  border: none;
}

.btn-primary:hover {
  background: #050f1f;
}

.btn-outline-primary {
  border-color: var(--court-navy);
  color: var(--court-navy);
}

.btn-outline-primary:hover {
  background: var(--court-navy);
  color: #fff;
}

/* ===== FOOTER ===== */
footer {
  background: #ffffff !important;
  border-top: 2px solid var(--border-soft);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 992px) {
  .sidebar {
    min-height: auto;
  }

  .header-top {
    text-align: center;
  }
}


/* ===== CAUSE LIST OVERLAY ===== */
.cause-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cause-dialog {
  background: #fff;
  width: 90%;
  max-width: 1100px;
  max-height: 90vh;
  border-radius: 10px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  display: flex;
  flex-direction: column;
}

.cause-header {
  padding: 15px 20px;
  border-bottom: 1px solid #ddd;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cause-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
}

.cause-body {
  padding: 20px;
  overflow-y: auto;
}

</style>



</head>

<body>
   <!-- JUDGE HEADER (FIXED TOP) -->
  <%- include('partials/judge-header', { judgeName }) %>
<div class="container-fluid" style="padding-top: 70px;">
  <div class="row g-3">

    <div class="container-fluid">
  <div class="row min-vh-100">

    <!-- ================= SIDEBAR ================= -->
<div class="col-12 col-lg-3 text-white p-3 position-sticky top-0"
     style="
       background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
       min-height: 100vh;
     ">


  <h4 class="d-flex align-items-center">
  <i class="fa-solid fa-gavel me-2 text-warning"></i>
  Hon. <%= judgeName %>
</h4>
<p class="muted-sm">Judicial Dashboard</p>
  <hr class="border-light">

  <nav class="nav flex-column">

    <!-- Home / Dashboard -->
    <a class="nav-link text-white" href="/">Home</a>
     
    <!-- View Cause List -->
<a class="nav-link text-white" href="javascript:void(0)"
   onclick="openCauseListPopup()">
  <i class="fa-solid fa-list me-1"></i> View Cause List
</a>


    <!-- AI Assisted Case File -->
    <a class="nav-link text-white"
   href="#"
   onclick="openTabAndScroll('aiFiles')">
  <i class="fa-solid fa-robot me-1"></i> AI Assisted Case File
</a>

<!-- Analytics -->
    <a class="nav-link text-white"
   href="#"
   onclick="openTabAndScroll('analytics')">
  <i class="fa-solid fa-chart-line me-1"></i> Analytics
</a>

    <!-- Case Management -->
    <a class="nav-link text-white"
   href="#"
   onclick="openTabAndScroll('caseManagement')">
  <i class="fa-solid fa-gavel me-1"></i> Case Management
</a>


    <!-- Communication -->
    <a class="nav-link text-white"
   href="#"
   onclick="openTabAndScroll('communication')">
  <i class="fa-solid fa-envelope me-1"></i> Communication
</a>


    <!-- ===== REPORTS TAB LINK ===== -->
<a class="nav-link text-white"
   href="#"
   onclick="openTabAndScroll('reports')">
  <i class="fa-solid fa-file-alt me-1"></i> Reports
</a>

    <!-- Lock Session -->
    <a class="nav-link text-white" href="#" id="lockSessionBtn">
      <i class="fa-solid fa-lock me-1"></i> Lock Session
    </a>
  </nav>
</div>


    <!-- ================= MAIN CONTENT ================= -->
    <div class="col-12 col-lg-9 p-3">

      <main class="container mt-4">

  <!-- =========================
       LIVE CASE COUNT CARDS
       ========================= -->
  <div class="row g-3 mb-4" id="priority-cards">

   <!-- Total Cases -->
<div class="col-12 col-md-3">
  <a href="/judges/total-cases" class="text-decoration-none">
    <div class="card p-3 text-center d-flex flex-column justify-content-center align-items-center"
         style="height: 220px; cursor:pointer;">
      <h6>Total Cases</h6>
      <canvas id="totalCasesChart" style="max-height: 100px; width: 100%;"></canvas>
      <h3 id="total-cases" class="mt-2 mb-0">0</h3>
    </div>
  </a>
</div>

    <!-- Pending Cases -->
<div class="col-12 col-md-3">
  <a href="/judges/pending-cases" class="text-decoration-none">
    <div class="card p-3 text-center d-flex flex-column justify-content-center align-items-center"
         style="height: 220px; cursor:pointer;">
      <h6>Pending Cases</h6>
      <canvas id="pendingCasesChart" style="max-height: 100px; width: 100%;"></canvas>
      <h3 id="pending-cases" class="mt-2 mb-0">0</h3>
    </div>
  </a>
</div>


    <!-- Disposed Cases -->
<div class="col-12 col-md-3">
  <a href="/judges/disposed-cases" class="text-decoration-none">
    <div class="card p-3 text-center d-flex flex-column justify-content-center align-items-center"
         style="height: 220px; cursor:pointer;">
      <h6>Disposed Cases</h6>
      <canvas id="disposedCasesChart" style="max-height: 100px; width: 100%;"></canvas>
      <h3 id="disposed-cases" class="mt-2 mb-0">0</h3>
    </div>
  </a>
</div>


    <!-- Delay Cases Chart (High / Medium / Low) -->
  <div class="col-12 col-md-3">
    <div class="card p-3 text-center" style="height:220px">
      <h6>Delay Cases Overview</h6>
      <canvas id="delayCasesChart" height="120"></canvas>
    </div>
  </div>
  </div>

  <script>
let delayCasesChart;

async function loadDelayCasesChart() {
  try {
    const res = await fetch("/judges/priority-data");
    const data = await res.json();

    const ctx = document
      .getElementById("delayCasesChart")
      .getContext("2d");

    if (delayCasesChart) {
      delayCasesChart.data.datasets[0].data = [
        data.high,
        data.medium,
        data.low
      ];
      delayCasesChart.update();
      return;
    }

    delayCasesChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: [
          "High Delay",
          "Medium Delay",
          "Low Delay"
        ],
        datasets: [{
          data: [data.high, data.medium, data.low],
          backgroundColor: [
            "#dc2626", // red
            "#f59e0b", // amber
            "#16a34a"  // green
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });

  } catch (err) {
    console.error("Delay chart load failed", err);
  }
}

// Load once on page load
loadDelayCasesChart();
</script>

  <!-- =========================
       TODAY'S SCHEDULE / PENDING / ALERTS
       ========================= -->
<div class="row g-3 mt-3">

  <!-- =========================
       TODAY'S PRIORITY
       ========================= -->
  <div class="col-12 col-md-4">
    <div class="card card-ghost p-3 h-100">
      <h6>View Today's Priority</h6>
      <div class="muted-sm mb-3">Live priority cases</div>

      <div class="d-flex flex-column gap-2">

        <div class="card p-2 d-flex justify-content-between align-items-center"
             style="background-color:#FFCDD2; cursor:pointer;"
             onclick="openPriorityPopup('high')">
          <div>High Priority Cases</div>
          <div id="high-priority-count" class="fw-bold">0</div>
        </div>

        <div class="card p-2 d-flex justify-content-between align-items-center"
             style="background-color:#FFF9C4; cursor:pointer;"
             onclick="openPriorityPopup('medium')">
          <div>Medium Priority Cases</div>
          <div id="medium-priority-count" class="fw-bold">0</div>
        </div>

        <div class="card p-2 d-flex justify-content-between align-items-center"
             style="background-color:#C8E6C9; cursor:pointer;"
             onclick="openPriorityPopup('low')">
          <div>Low Priority Cases</div>
          <div id="low-priority-count" class="fw-bold">0</div>
        </div>

      </div>
    </div>
  </div>

<!-- =========================
     Script to fetch live counts
     ========================= -->
<script>
async function loadPriorityCounts() {
  try {
    const res = await fetch("/judges/priority-data"); // your backend route
    const data = await res.json();

    document.getElementById("high-priority-count").innerText = data.high;
    document.getElementById("medium-priority-count").innerText = data.medium;
    document.getElementById("low-priority-count").innerText = data.low;
  } catch (err) {
    console.error("Failed to load priority counts", err);
  }
}

// Call on page load
loadPriorityCounts();
</script>


    <!-- Pending Actions -->
    <div class="col-12 col-md-3">
      <div class="card card-ghost p-3">
        <h6>Pending Actions</h6>
        <a href="/pending-cases" class="btn btn-warning mt-2">View Pending Cases</a>
        <ul class="list-unstyled mt-2">
          <li class="py-2 d-flex justify-content-between align-items-center">
            <div>Orders to review</div><div class="badge bg-warning text-dark">3</div>
          </li>
          <li class="py-2 d-flex justify-content-between align-items-center">
            <div>Evidence approval</div><div class="badge bg-info text-dark">2</div>
          </li>
        </ul>
      </div>
    </div>

    <!-- Smart Alerts -->
    <div class="col-12 col-md-4">
      <div class="card p-3">
        <h6>Smart Alerts ‚Äî AI</h6>
        <ul class="list-unstyled mb-0" id="alerts-list">
          <% if (alerts && alerts.length > 0) { %>
            <% alerts.forEach(a => { %>
              <li class="py-2 border-bottom"><%= a.message %></li>
            <% }) %>
          <% } else { %>
            <li class="py-2">No alerts</li>
          <% } %>
        </ul>
      </div>
    </div>

  </div>

</main>

<!-- Charts Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadDashboardCounts() {
  try {
    const res = await fetch("/judges/priority-data");
    const data = await res.json();

    document.getElementById("total-cases").innerText = data.high + data.medium + data.low;
    document.getElementById("pending-cases").innerText = data.high + data.medium;
    document.getElementById("disposed-cases").innerText = data.low;

    new Chart(document.getElementById("totalCasesChart"), {
      type: 'doughnut',
      data: {
        labels: ['Pending', 'Disposed'],
        datasets: [{
          data: [data.high + data.medium, data.low],
          backgroundColor: ['#FFA500', '#28a745']
        }]
      },
      options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById("pendingCasesChart"), {
      type: 'bar',
      data: {
        labels: ['Pending'],
        datasets: [{ label: 'Cases', data: [data.high + data.medium], backgroundColor: '#FFA500' }]
      },
      options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    new Chart(document.getElementById("disposedCasesChart"), {
      type: 'pie',
      data: {
        labels: ['Disposed'],
        datasets: [{ data: [data.low], backgroundColor: ['#28a745'] }]
      },
      options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

  } catch (err) { console.error(err); }
}
loadDashboardCounts();
</script>


<div class="container-fluid py-4">
  <div class="row g-3">

<!-- ================= SEARCH BY CNR ================= -->
      <form method="GET" action="/judges" class="card p-3 mb-4">
        <label class="form-label fw-bold">Search by CNR Number</label>
        <div class="d-flex gap-2">
          <input type="text" name="cnr" class="form-control" placeholder="Enter CNR Number">
          <button class="btn btn-primary">Search</button>
        </div>
      </form>


      <!-- ================= TABS ================= -->
      <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#aiFiles" type="button">AI Assisted Case Files</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#analytics" type="button">Analytics</button>
        </li>
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#caseManagement" type="button">Case Management</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#communication" type="button">Communication</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reports" type="button">Reports</button>
        </li>
      </ul>

      <!-- ================= TAB CONTENT ================= -->
      <div class="tab-content">

        <!-- ===== AI-ASSISTED CASE FILES ===== -->

            <!-- ================= AI ASSISTED CASE FILES ================= -->
<div class="tab-pane fade" id="aiFiles" role="tabpanel">

  <!-- ===== AI CASE SUMMARY ===== -->
  <div class="card p-3 shadow-sm mb-4">
    <h6 class="fw-semibold">AI-Assisted Case Summary</h6>

    <div class="small text-muted mb-3">
      Upload a case file and generate an AI-based judicial summary
    </div>

    <input type="file"
           id="aiCaseFile"
           class="form-control mb-3"
           accept=".pdf,.doc,.docx,.txt">

    <button type="button"
            class="btn btn-primary w-100"
            onclick="generateAiSummary()">
      ü§ñ Generate Summary
    </button>

    <div id="aiLoading"
         class="mt-3 text-primary small"
         style="display:none;">
      ‚è≥ Generating summary, please wait...
    </div>

    <div id="aiSummaryResult"
         class="mt-3 p-3 border rounded small"
         style="display:none; background:#f8fafc;">
    </div>
  </div>

  <!-- ===== ANOMALY & DISPOSAL TIME (NOW CORRECTLY HERE) ===== -->
  <div class="card p-3 shadow-sm">
    <h6>Anomaly and Disposal Time</h6>

    <div class="text-muted mb-2">
      AI-based anomaly detection & disposal time prediction
    </div>

    <div class="d-flex gap-2 mb-3">
      <input type="text"
             id="anomalyCnrInput"
             class="form-control"
             placeholder="Enter CNR Number">

      <button class="btn btn-primary"
              onclick="viewAnomalyAndDisposal()">
        View Anomaly and Disposal Time
      </button>
    </div>

    <div id="anomalyDisposalResult" style="display:none;">
      <div class="row g-3">

        <div class="col-md-4">
          <div class="alert alert-danger text-center">
            <b>Risk Flag</b>
            <div id="riskFlag" class="fs-5 mt-1"></div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="alert alert-warning text-center">
            <b>Estimated Disposal Days</b>
            <div id="disposalDays" class="fs-5 mt-1"></div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="alert alert-info text-center">
            <b>Hearing Insights</b>
            <div id="hearingDetails" class="small mt-1"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>


        <!-- ===== CASE MANAGEMENT ===== -->
        <div class="tab-pane fade show active" id="caseManagement">
          <div class="row g-3">
            <!-- ================= CASE MANAGEMENT CONTROLS ================= -->
<!-- ================= CASE MANAGEMENT CONTROLS ================= -->
 <div class="col-12 mt-3">
  <div class="row g-3">
<div class="col-lg-6">
  <div class="card p-3 shadow-sm">
    <h6 class="fw-semibold mb-2">Case Management Controls</h6>

    <p class="text-muted small">
      Enter CNR number to perform case actions
    </p>

    <!-- CNR INPUT -->
    <div class="input-group mb-3">
      <span class="input-group-text">CNR</span>
      <input
        type="text"
        id="cnrInput"
        class="form-control"
        placeholder="Enter CNR Number"
      >
    </div>

    <!-- Hidden selected CNR -->
    <input type="hidden" id="selectedCNR">

    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-outline-primary" onclick="setCNRAndGo('/judges/notice')">
        üì® Send Notice
      </button>

      <button class="btn btn-outline-danger" onclick="setCNRAndGo('/judges/penalty')">
        üí∏ Delay Penalty
      </button>

      <button class="btn btn-outline-secondary" onclick="setCNRAndGo('/judges/service-status')">
        üì¶ Track Service Status
      </button>

      <button class="btn btn-outline-success" onclick="setCNRAndGo('/judges/schedule')">
        üìÖ Fix Next Hearing
      </button>
    </div>
  </div>
</div>



<script>
  function setCNRAndGo(baseUrl) {
    const input = document.getElementById("cnrInput");
    const cnr = input.value.trim();

    if (!cnr) {
      alert("‚ö†Ô∏è Please enter a CNR number");
      input.focus();
      return;
    }

    // store it (optional, for consistency)
    document.getElementById("selectedCNR").value = cnr;

    // navigate
    window.location.href = baseUrl + "?cnr=" + encodeURIComponent(cnr);
  }
</script>

 <!-- Smart Scheduling & Case Management Controls -->
<div class="col-lg-6">
  <div class="card p-3">
    <h6>Smart Scheduling</h6>
    <div class="muted-sm mb-2">
      Auto-suggested hearing dates & priority-based scheduling
    </div>

    <input type="text" id="cnr" class="form-control mb-2" placeholder="Enter CNR Number">

    <div class="d-flex gap-2 mb-2">
      <input type="date" id="selectedDate" class="form-control">
      <button type="button" class="btn btn-primary" onclick="getSmartSchedule()">
  Suggest
</button>
    </div>

    <div id="smartResult" class="small text-muted"></div>
  </div>
</div>
</div>
            </div>

          </div>
        </div>


<!--Script for smart schedule-->

<script>
async function getSmartSchedule() {
  const cnr = document.getElementById("cnr").value.trim();
  const selectedDate = document.getElementById("selectedDate").value;
  const resultDiv = document.getElementById("smartResult");

  if (!cnr) {
    resultDiv.innerHTML = "<span class='text-danger'>Please enter CNR number</span>";
    return;
  }

  resultDiv.innerHTML = "‚è≥ Fetching smart schedule...";

  try {
    const response = await fetch(
      "https://nyayamitra-smart-scheduling.onrender.com/smart-schedule",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          cnr_number: cnr,
          selected_date: selectedDate || null
        })
      }
    );

    if (!response.ok) {
      throw new Error("Failed to fetch schedule");
    }

    const data = await response.json();

    const nextDate = selectedDate
      ? new Date(selectedDate)
      : new Date();

    nextDate.setDate(nextDate.getDate() + data.suggested_next_hearing_days);

    resultDiv.innerHTML = `
      <div class="mt-2">
        <strong>Priority:</strong> ${data.priority}<br>
        <strong>Suggested After:</strong> ${data.suggested_next_hearing_days} days<br>
        <strong>Next Hearing Date:</strong> ${nextDate.toISOString().split("T")[0]}<br>
        <strong>Stage:</strong> ${data.stage}<br>
        <strong>Hearings Count:</strong> ${data.hearing_count}<br>
        <strong>Reason:</strong> ${data.reason}
      </div>
    `;
  } catch (error) {
    console.error(error);
    resultDiv.innerHTML =
      "<span class='text-danger'>Unable to fetch smart scheduling data</span>";
  }
}
</script>

        <!-- ===== COMMUNICATION ===== -->
<!-- ===== COMMUNICATION ===== -->
<div class="tab-pane fade" id="communication">
  <div class="row g-3">

    <!-- LEFT: STORE NOTES -->
    <div class="col-lg-6">
      <div class="card p-3 shadow-sm h-100">

        <h6 style="color:#1e3a8a; font-weight:600;">
          üìù Store Case Notes
        </h6>

        <input type="text"
               id="storeCaseId"
               class="form-control mb-2"
               placeholder="Enter Case ID (CNR)">

        <textarea id="caseNotes"
                  class="form-control mb-3"
                  rows="5"
                  placeholder="Write judicial notes here..."></textarea>

        <button class="btn text-white w-100"
                style="background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
                       border:none;"
                onclick="storeNotes()">
          Save Notes
        </button>

        <div id="storeMsg" class="small mt-2"></div>

      </div>
    </div>

    <!-- RIGHT: API JSON RESPONSE -->
    <div class="col-lg-6">
      <div class="card p-3 shadow-sm h-100">

        <h6 style="color:#1e3a8a; font-weight:600;">
          üìÑ API Response
        </h6>

        <pre id="jsonResponse"
             class="p-3 rounded border"
             style="background:#0f172a; color:#e5e7eb; height:100%; overflow:auto;">
Waiting for response...
        </pre>

      </div>
    </div>

  </div>
</div>


<!--Script for notes and reminder-->
<script>
async function storeNotes() {
  const cnr = document.getElementById("storeCaseId").value.trim();
  const note = document.getElementById("caseNotes").value.trim();
  const msgDiv = document.getElementById("storeMsg");
  const jsonBox = document.getElementById("jsonResponse");

  // Reset UI
  msgDiv.innerHTML = "";
  jsonBox.textContent = "";

  // Validation
  if (!cnr || !note) {
    msgDiv.innerHTML =
      `<span class="text-danger">CNR and Notes are required</span>`;
    return;
  }

  // Always call SAME-ORIGIN backend (prevents CORS issues)
  const url = window.location.origin + "/api/save-note";
  console.log("Saving note via:", url);

  jsonBox.textContent = "Saving notes...";

  try {
    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        cnr: cnr,
        note: note   // ‚úÖ backend expects `note`
      })
    });

    // Backend reachable but returned error
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(errorText || "Backend error");
    }

    const data = await response.json();

    // Success UI
    msgDiv.innerHTML =
      `<span class="text-success">Notes saved successfully</span>`;

    // Show exact JSON response on right panel
    jsonBox.textContent = JSON.stringify(data, null, 2);

    // Optional clear textarea
    document.getElementById("caseNotes").value = "";

  } catch (error) {
    console.error("Save notes error:", error);

    msgDiv.innerHTML =
      `<span class="text-danger">Failed to save notes</span>`;

    jsonBox.textContent =
      "Request failed.\n\n" + error.message;
  }
}
</script>



      <!-- ===== ANALYTICS ===== -->
<div class="tab-pane fade" id="analytics">
  <div class="row g-4 mt-3">

    <!-- CASE DISPOSAL RATE -->
    <div class="col-lg-6">
      <div class="card p-3 shadow-sm analytics-card">
        <h6 class="mb-3">Case Disposal Rate</h6>
        <div class="chart-box">
          <canvas id="caseDisposalChart"></canvas>
        </div>
      </div>
    </div>

    <!-- CASE TYPE DISTRIBUTION -->
    <div class="col-lg-6">
      <div class="card p-3 shadow-sm analytics-card">
        <h6 class="mb-3">Case Type Distribution</h6>
        <div class="chart-box">
          <canvas id="caseTypeChart"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let disposalChartInstance = null;
let caseTypeChartInstance = null;
</script>

<script>
async function loadAnalyticsCharts() {
  try {
    const res = await fetch("/judges/analytics-live");
    const data = await res.json();

    /* ---------- Disposal Rate Chart ---------- */
    const disposalCanvas = document.getElementById("caseDisposalChart");
    if (!disposalCanvas) return;

    if (disposalChartInstance) {
      disposalChartInstance.destroy();
    }

    disposalChartInstance = new Chart(disposalCanvas, {
      type: "line",
      data: {
        labels: data.disposal.years,
        datasets: [{
          label: "Disposed Cases",
          data: data.disposal.counts,
          fill: true,
          borderColor: "#3b82f6",
          backgroundColor: "rgba(59,130,246,0.3)",
          tension: 0.4,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } }
      }
    });

    /* ---------- Case Type Distribution ---------- */
    const typeCanvas = document.getElementById("caseTypeChart");
    if (!typeCanvas) return;

    if (caseTypeChartInstance) {
      caseTypeChartInstance.destroy();
    }

    caseTypeChartInstance = new Chart(typeCanvas, {
      type: "doughnut",
      data: {
        labels: Object.keys(data.caseTypes),
        datasets: [{
          data: Object.values(data.caseTypes),
          backgroundColor: [
            "#3b82f6",
            "#fb7185",
            "#fb923c",
            "#facc15",
            "#22c55e"
          ]
        }]
      },
      options: {
        cutout: "65%",
        plugins: {
          legend: { position: "bottom" }
        }
      }
    });

  } catch (err) {
    console.error("Analytics chart error:", err);
  }
}

/* üî• LOAD ONLY WHEN ANALYTICS TAB OPENS */
document
  .querySelector('[data-bs-target="#analytics"]')
  .addEventListener("shown.bs.tab", () => {
    setTimeout(loadAnalyticsCharts, 200);
  });
</script>

<!--Script for summary-->
<script>
async function generateAiSummary() {

  const fileInput = document.getElementById("aiCaseFile");
  const loading = document.getElementById("aiLoading");
  const resultBox = document.getElementById("aiSummaryResult");

  if (!fileInput.files.length) {
    alert("Please upload a case file first.");
    return;
  }

  loading.style.display = "block";
  resultBox.style.display = "none";
  resultBox.innerHTML = "";

  try {
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    const response = await fetch(
      "https://pratm-ai-case-summary-api.hf.space/summarize",
      {
        method: "POST",
        body: formData
      }
    );

    if (!response.ok) {
      const errText = await response.text();
      console.error("API error:", errText);
      throw new Error("Summarization failed");
    }

    const data = await response.json();
    console.log("AI summary response:", data);

    // ‚úÖ USING YOUR EXACT JSON FORMAT
    resultBox.innerHTML = `
      <strong>üìÑ File:</strong> ${data.filename}<br><br>
      <strong>üß† AI Summary:</strong><br>
      ${data.summary}
    `;

    resultBox.style.display = "block";

  } catch (error) {
    console.error(error);
    resultBox.innerHTML =
      "<span class='text-danger'>‚ùå Error generating summary. Please try again.</span>";
    resultBox.style.display = "block";
  } finally {
    loading.style.display = "none";
  }
}
</script>


<!--Script for anamoly and disposal detection-->
<script>
async function viewAnomalyAndDisposal() {
  const cnr = document
    .getElementById("anomalyCnrInput")
    .value
    .trim();

  const resultBox = document.getElementById("anomalyDisposalResult");

  if (!cnr) {
    alert("Please enter CNR number");
    return;
  }

  resultBox.style.display = "none";

  try {
    const res = await fetch(
      "https://shra-108029-judicial-ai-api.hf.space/predict_all",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cnr_number: cnr })
      }
    );

    if (!res.ok) throw new Error("API error");

    const data = await res.json();

    // Populate UI
    document.getElementById("riskFlag").innerText = data.risk_flag;
    document.getElementById("disposalDays").innerText =
      Math.round(data.estimated_disposal_days) + " days";

    document.getElementById("hearingDetails").innerHTML = `
      Hearings: ${data.prediction_details.num_hearings}<br>
      Avg Gap: ${Math.round(data.prediction_details.avg_gap_days)} days<br>
      Max Gap: ${data.prediction_details.max_gap_days} days
    `;

    resultBox.style.display = "block";

  } catch (err) {
    console.error(err);
    alert("Failed to fetch anomaly & disposal data");
  }
}
</script>


        <!--Report Section-->

        <div class="tab-pane fade" id="reports" role="tabpanel">
  <div class="row g-3 mt-3">
    <div class="col-lg-12">
      <div class="card p-3 shadow-sm">
        <h6 class="fw-bold mb-1">Reports</h6>
        <div class="text-muted mb-3">View judicial reports</div>

        <a href="https://app.powerbi.com/view?r=eyJrIjoiYjhjYjVlMDQtODQ3Mi00NzE5LWE5ZDctZjBiMDM0YWQ2MGFiIiwidCI6IjA4NzI3N2ViLTk5YzgtNDgzMy1iY2FlLTU2MWUzMjhlNWRjZCJ9"
           target="_blank"
           class="btn btn-outline-success w-100">
          üìÑ View Report
        </a>
      </div>
    </div>
  </div>
</div>


      <!-- tab-content end -->
</div>

<!--FReports script-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<!--Lock session script-->
<script>
document.getElementById('lockSessionBtn').addEventListener('click', function() {
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.background = 'rgba(0,0,0,0.7)';
  overlay.style.color = '#fff';
  overlay.style.display = 'flex';
  overlay.style.justifyContent = 'center';
  overlay.style.alignItems = 'center';
  overlay.style.fontSize = '2rem';
  overlay.innerHTML = 'üîí Session Locked';
  document.body.appendChild(overlay);
  overlay.onclick = () => overlay.remove();
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


<!--Samrt Schedule-->
<script>
async function getSmartSchedule() {
    const cnr = document.getElementById("cnr").value.trim();
    const selectedDate = document.getElementById("selectedDate").value;

    if (!cnr) {
        alert("Please enter CNR number");
        return;
    }

    try {
        const response = await fetch("/judges/smart-schedule", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                cnr_number: cnr,
                selectedDate
            })
        });

        if (!response.ok) {
            throw new Error("Failed to fetch smart schedule");
        }

        const data = await response.json();

        document.getElementById("smartResult").innerHTML = `
            <p><b>Priority:</b> ${data.priority}</p>
            <p><b>Suggested Days:</b> ${data.suggested_next_hearing_days}</p>
            <p><b>Reason:</b> ${data.reason}</p>
            <p><b>Hearing Count:</b> ${data.hearing_count}</p>
        `;
    } catch (err) {
        document.getElementById("smartResult").innerHTML =
            "<span class='text-danger'>Smart scheduling service unavailable</span>";
        console.error(err);
    }
}
</script>

<!--AI summary-->
<script>
async function getAiSummary() {
    const cnr = document.getElementById("aiCnr").value.trim();
    const resultDiv = document.getElementById("aiSummaryResult");

    if (!cnr) {
        alert("Please enter CNR number");
        return;
    }

    resultDiv.innerHTML = "‚è≥ Generating AI summary...";

    try {
        const response = await fetch("/judges/ai-summary", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ cnr_number: cnr })
        });

        if (!response.ok) {
            throw new Error("Failed to fetch AI summary");
        }

        const data = await response.json();

        resultDiv.innerHTML = `
          <div class="border rounded p-2 bg-light">
            <b>CNR:</b> ${data.cnr_number}<br><br>
            <b>AI Case Summary:</b>
            <p style="text-align: justify;">${data.ai_case_summary}</p>
          </div>
        `;
    } catch (err) {
        console.error(err);
        resultDiv.innerHTML =
          "<span class='text-danger'>AI summary service unavailable</span>";
    }
}
</script>

<!--Case Timeline-->
<script>
async function getTimeline() {
  const cnr = document.getElementById("cnrInput").value;

  if (!cnr) {
    alert("Enter CNR number first");
    return;
  }

  const res = await fetch("/judges/ai-timeline", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cnr_number: cnr })
  });

  const data = await res.json();

  const list = document.getElementById("timelineList");
  list.innerHTML = "";

  data.timeline.forEach(item => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${item.date} ‚Äì ${item.title}</strong><br>
      <small>${item.description}</small>
    `;
    list.appendChild(li);
  });

  document.getElementById("timelineSection").style.display = "block";
}
</script>

<!--Anamoly and disposal section-->
<script>
async function getAnomaly() {
  const cnr = document.getElementById("cnrInput").value;
  if (!cnr) return alert("Enter CNR number");

  const res = await fetch("/judges/ai-anomaly", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cnr_number: cnr })
  });

  const data = await res.json();
  document.getElementById("anomalyText").innerText =
    data.anomaly || "No anomalies detected.";
  document.getElementById("anomalySection").style.display = "block";
}


async function getDisposal() {
  const cnr = document.getElementById("cnrInput").value;
  if (!cnr) return alert("Enter CNR number");

  const res = await fetch("/judges/ai-disposal", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ cnr_number: cnr })
  });

  const data = await res.json();
  document.getElementById("disposalText").innerText =
    data.disposal_prediction || "Disposal estimation unavailable.";
  document.getElementById("disposalSection").style.display = "block";
}
</script>

<!--Priority logic-->
<script>
async function fetchPriorityCounts() {
  try {
    const res = await fetch("/judges/priority-data");
    const data = await res.json();

    document.getElementById("highCount").innerText = data.high;
    document.getElementById("mediumCount").innerText = data.medium;
    document.getElementById("lowCount").innerText = data.low;
  } catch (err) {
    console.error("Priority data fetch failed:", err);
  }
}

// Load on page load
fetchPriorityCounts();

// Optional: Refresh every 30 sec
// setInterval(fetchPriorityCounts, 30000);
</script>

<!--Snapshot cards-->
<script>
// Sample code to populate Smart Alerts dynamically
const alertsList = document.getElementById('alerts-list');
const btnRefreshAlerts = document.getElementById('btn-refresh-alerts');

function loadAlerts() {
  alertsList.innerHTML = ''; // clear existing
  const alerts = [
    'Case KAHC012345 needs urgent review',
    'Pending ADR referral for Case KAHC067890',
    'High-priority hearing tomorrow at 10:00 AM'
  ];

  alerts.forEach(alert => {
    const li = document.createElement('li');
    li.className = 'py-2 border-bottom';
    li.innerText = alert;
    alertsList.appendChild(li);
  });
}

// Initial load
loadAlerts();

// Refresh button
btnRefreshAlerts.addEventListener('click', loadAlerts);
</script>

<!-- ================= PRIORITY CASES MODAL ================= -->
<div class="modal fade" id="priorityModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priorityModalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="priorityModalBody">
          <div class="text-center text-muted">Loading cases...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const PRIORITY_API =
  "https://shra-108029-judicial-delay-risk-api.hf.space/priority_cases";

async function openPriorityPopup(type) {
  const modalTitle = document.getElementById("priorityModalTitle");
  const modalBody = document.getElementById("priorityModalBody");

  modalTitle.innerText =
    type === "high" ? "High Priority Delay Cases"
    : type === "medium" ? "Medium Priority Delay Cases"
    : "Low Priority Delay Cases";

  modalBody.innerHTML =
    "<div class='text-center text-muted'>Loading cases...</div>";

  const modal = new bootstrap.Modal(
    document.getElementById("priorityModal")
  );
  modal.show();

  try {
    const res = await fetch(PRIORITY_API);
    const data = await res.json();

    const cases =
      type === "high" ? data.high_priority
      : type === "medium" ? data.medium_priority
      : data.low_priority;

    if (!cases || cases.length === 0) {
      modalBody.innerHTML =
        "<div class='alert alert-info'>No cases found</div>";
      return;
    }

    modalBody.innerHTML = cases.map(c => `
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <h6 class="text-primary mb-1">
            CNR: ${c.cnr_number} | Case No: ${c.case_number}
          </h6>

          <div class="small text-muted mb-2">
            ${c.case_type} ‚Üí ${c.sub_case_type}
          </div>

          <div class="row small">
            <div class="col-md-4"><b>Hearings:</b> ${c.total_hearings}</div>
            <div class="col-md-4"><b>Avg Gap:</b> ${c.avg_gap_days} days</div>
            <div class="col-md-4"><b>Priority Score:</b> ${c.priority_score}</div>
          </div>

          <hr class="my-2"/>

          <div class="small">
            <b>Reasons:</b>
            <ul>
              ${c.reasons.map(r => `<li>${r}</li>`).join("")}
            </ul>
          </div>

          ${
            c.suggested_actions && c.suggested_actions.length
              ? `<div class="small">
                   <b>Suggested Actions:</b>
                   <ul>
                     ${c.suggested_actions.map(a => `<li>${a}</li>`).join("")}
                   </ul>
                 </div>`
              : ""
          }
        </div>
      </div>
    `).join("");

  } catch (err) {
    console.error(err);
    modalBody.innerHTML =
      "<div class='alert alert-danger'>Failed to load priority cases</div>";
  }
}
</script>

<!--Cause list script-->
<!-- ===== CAUSE LIST MODAL ===== -->
 <!-- ===== CAUSE LIST OVERLAY POPUP ===== -->
<div id="causeListOverlay" class="cause-overlay d-none">

  <div class="cause-dialog">

    <!-- Header -->
    <div class="cause-header">
      <h5>Cause List</h5>
      <button class="cause-close" onclick="closeCauseListPopup()">√ó</button>
    </div>

    <!-- Body -->
    <div class="cause-body">

      <!-- Date -->
      <div class="row mb-3">
        <div class="col-md-4">
          <input type="date" id="causeDate" class="form-control">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary" onclick="loadCauseList()">
            Load Cause List
          </button>
        </div>
      </div>

      <!-- Loader -->
      <div id="causeLoader" class="text-center d-none">
        <div class="spinner-border text-primary"></div>
      </div>

      <!-- Scrollable Table -->
      <div class="table-responsive" style="max-height: 60vh;">
        <table class="table table-bordered table-striped">
          <thead class="table-dark sticky-top">
            <tr>
              <th>#</th>
              <th>Court Name</th>
              <th>Court No</th>
              <th>Bench</th>
              <th>Case Stage</th>
            </tr>
          </thead>
          <tbody id="causeListBody">
            <tr>
              <td colspan="5" class="text-center text-muted">
                Select a date
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

</div>


<!--Cause list script-->
<script>
function openCauseListPopup() {
  document.body.style.overflow = "hidden";
  document.getElementById("causeListOverlay").classList.remove("d-none");

  const dateInput = document.getElementById("causeDate");
  if (!dateInput.value) {
    dateInput.value = new Date().toISOString().split("T")[0];
  }
}

function closeCauseListPopup() {
  document.body.style.overflow = "";
  document.getElementById("causeListOverlay").classList.add("d-none");
}

async function loadCauseList() {
  const date = document.getElementById("causeDate").value;
  const loader = document.getElementById("causeLoader");
  const tbody = document.getElementById("causeListBody");

  if (!date) {
    alert("Please select a date");
    return;
  }

  loader.classList.remove("d-none");
  tbody.innerHTML = "";

  try {
    const res = await fetch(`/api/cause-list?date=${date}`);
    if (!res.ok) throw new Error("API error");

    const data = await res.json();

    if (!data.cases || data.cases.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-muted">
            No cases found
          </td>
        </tr>`;
      return;
    }

    data.cases.forEach((c, i) => {
      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${i + 1}</td>
          <td>${c.court_name || "-"}</td>
          <td>${c.court_number || "-"}</td>
          <td>${c.bench || "-"}</td>
          <td>${c.case_stage || "-"}</td>
        </tr>
      `);
    });

  } catch (err) {
    console.error(err);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-danger text-center">
          Failed to load data
        </td>
      </tr>`;
  } finally {
    loader.classList.add("d-none");
  }
}
</script>
<script>
function openTabAndScroll(tabId) {
  // 1Ô∏è‚É£ Find the tab button that opens this tab
  const tabButton = document.querySelector(
    `[data-bs-target="#${tabId}"]`
  );

  if (!tabButton) {
    console.error("Tab not found:", tabId);
    return;
  }

  // 2Ô∏è‚É£ Activate the Bootstrap tab
  const tab = new bootstrap.Tab(tabButton);
  tab.show();

  // 3Ô∏è‚É£ Smooth scroll to the tab content
  setTimeout(() => {
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
      tabContent.scrollIntoView({
        behavior: "smooth",
        block: "start"
      });
    }
  }, 200); // delay ensures tab is visible
}
</script>


<%- include('partials/footer') %>


</body>
</html>